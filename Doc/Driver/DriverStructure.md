# FinNAV 设备驱动框架

FinNAV内置简单的设备驱动框架，并提供基于BSP的驱动支持，用户可以根据器件片上资源情况选择是否启用这些库文件。本文档是对该框架设计思路和使用方式的简要介绍

如果开发者需要将FinNAV连同设备驱动框架移植到其他芯片/板卡，可根据文档[FinNAV驱动移植](DriverPort.md)中描述的步骤来将FinNAV移植到其他可用的设备上

## 设计哲学

FinNAV设备驱动框架基于C面向对象编写，提供MCU常见片上外设的自检、复位、休眠、读、写及综合控制的驱动支持

FinNAV中，一种片上外设被视为一个**设备类**，该外设的每路电路都被视为该类实例化出的一个**设备对象**，如果基于RTOS设备驱动或厂商提供的HAL库移植FinNAV驱动框架，则将底层驱动规定的设备类/结构体作为**设备对象**。

外设寄存器映射到的内存空间被看作设备类的属性集合，内存空间内每组寄存器都被视为对应设备对象**实例**的一个**属性**；如果使用RTOS设备驱动或厂商提供的HAL库，指向具体设备操作的句柄则被视作该对象实例的一个属性，利用空指针进行类型转换。

所有片上外设都由**设备对象链表**管理，所有设备都被挂载到同一个设备对象链表的实例，使用设备类型区分设备类，使用设备ID区分外设对象。

> GPIO外设抽象成 `drv_gpio_t` 设备类，每个引脚都是该设备类的一个实例化对象，引脚号 `pin` 和设备对象一一对应，同时每组GPIO设备对象中的实例属性指针都指向对应的外设寄存器。举例来说，一般的stm32中，GPIOA、GPIOB、GPIOC......的地址空间指针被依次赋给设备对象。而每个引脚号都对应一批设备对象，PA0、PA1......都归于GPIOA管理，以此类推。

## 文件结构

驱动框架源文件位于`FinNAV/Driver`下。`include`子目录包含FinNAV驱动框架头文件，`Driver.c`文件提供了外设对象的相关操作，

FinNAV通过该框架**部分封装**底层硬件细节，为不同场景应用提供快速部署能力



设备驱动移植文件统一放置在`/Boards/<BSP目录>/Port/`

`Peripheral`子目录包含FinNAV驱动框架源文件，



`BSP`子目录包含设备板级支持包移植文件。FinNAV规定的板级支持包（Board Support Package，BSP）是指器件在寄存器内存映射C库支持下可使用的低层次API（裸机标准C外设库、裸机寄存器映射C库）或高层次抽象外设库支持下可调用的API（硬件抽象层、RTOS外设驱动框架提供的底层接口）。

> FinNAV提供空白的BSP移植模板

*每种设备的板级支持包都至少实现GPIO和UART的基础功能以提供FinNAV调试信息输出*

## 设备类

### 基设备类

所有设备类都派生自 `rov_dev_t` 基设备类，该类包含了如下属性：

* 设备ID

* 设备特性标志

* 设备管理链表

* 设备类型

* 设备实例指针

    * 可以用属性列表，也可以用底层驱动的设备对象

* 设备中断关联

    * 中断号
    * 中断回调函数
    * 中断回调函数参数

* 设备控制方法

    包含一系列回调函数供驱动注册：

    * 设备自检回调函数
    * 设备复位回调函数
    * 设备休眠回调函数
    * 设备读取回调函数
    * 设备写入回调函数
    * 设备综合控制回调函数

* 用户定义数据区指针

### GPIO外设类

FinNAV中每个GPIO设备对象（下称`drv_gpio_t`）能够保留至多32个属性，因此如果实际的设备中一组GPIO有超过32个IO端口，需要将其分割成多个GPIO设备对象。

典型地，对于STM32，FinNAV将每个`drv_gpio_t`的属性保留为16，一个PORT对应一个设备对象

FinNAV提供`drv_gpio_read`、`drv_gpio_write`、`drv_gpio_setmode`供用户使用。用户通过obj参数筛选要操作的GPIO设备对象，使用pin_num参数指定要操作的IO号

> 由于C的限制所有API都需要用户预先指定要操作的外设对象列表 `drv_gpio_t* drv`

### UART外设类

FinNAV将每个UART设备看作设备对象，并将所有用到的UART统一分配到外设对象列表中，且每个设备都可以挂载不同的bsp驱动来应对不同串口需要控制不同板级协议的情况。

FinNAV提供`drv_uart_read`、`drv_uart_write`、`drv_uart_set_baudrate`、`drv_uart_set_databits`、`drv_uart_set_stopbit`、`drv_uart_set_parity`、`drv_uart_set_flow`、`drv_uart_set_tx_timeout`、`drv_uart_set_rx_timeout`供用户使用。用户需要通过obj参数筛选出要操作的UART设备对象

UART设备实例在初始化时候挂载到UART设备对象中，用户可以自行决定UART设备实例和设备ID的对应关系，也可以通过`drv_uart_find`传入设备实例来查找对应的设备ID

### PWM外设类

TODO

### 硬件定时器外设类

TODO

### I2C外设类

TODO

### 软件I2C外设类

TODO

### 看门狗外设类

TODO

### SPI外设类

TODO

### ADC外设类

TODO

### CAN外设类

TODO

### CANFD外设类

TODO
